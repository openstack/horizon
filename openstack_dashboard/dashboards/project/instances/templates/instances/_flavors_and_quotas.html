{% load i18n horizon humanize bootstrap %}
{% load size_filters %}

{% block help_message %}{% endblock %}

<h4>{% trans "Flavor Details" %}</h4>
<table class="flavor_table table table-striped table-fixed">
  <tbody>
    <tr><td class="flavor_name">{% trans "Name" %}</td><td><span id="flavor_name" class="truncate"></span></td></tr>
    <tr><td class="flavor_name">{% trans "VCPUs" %}</td><td><span id="flavor_vcpus"></span></td></tr>
    <tr><td class="flavor_name">{% trans "Root Disk" %}</td><td><span id="flavor_disk"></span> {% trans "GB" %}</td></tr>
    <tr><td class="flavor_name">{% trans "Ephemeral Disk" %}</td><td><span id="flavor_ephemeral"></span> {% trans "GB" %}</td></tr>
    <tr><td class="flavor_name">{% trans "Total Disk" %}</td><td><span id="flavor_disk_total"></span> {% trans "GB" %}</td></tr>
    <tr><td class="flavor_name">{% trans "RAM" %}</td><td><span id="flavor_ram" class="flavor-ram"></span> {% trans "GB" %}</td></tr>

    <!-- NEW: headline row for Hot Add -->
    <tr id="hot_add_headline_row" style="display:none;">
      <td colspan="2" class="text-danger"><strong>{% trans "Hot Add Enabled" %}</strong></td>
    </tr>

    <tr>
      <td class="flavor_name">{% trans "Minimum CPU" %}</td>
      <td class="text-danger"><span id="flavor_minimum_cpu"></span></td>
    </tr>
    <tr>
      <td class="flavor_name">{% trans "Minimum Memory" %}</td>
      <td class="text-danger"><span id="flavor_minimum_memory"></span> {% trans "GB" %}</td>
    </tr>
  </tbody>
</table>

<div class="quota-dynamic">
  <h4>{% trans "Project Limits" %}</h4>

  <div class="quota_title">
    <strong class="pull-left">{% trans "Number of Instances" %}</strong>
    <span class="pull-right">
      {% blocktrans trimmed with used=usages.totalInstancesUsed|intcomma quota=usages.maxTotalInstances|intcomma|quotainf %}
      {{ used }} of {{ quota }} Used
      {% endblocktrans %}
    </span>
  </div>

  {% minifyspace %}
  <div id="{{ resize_instance|yesno:'quota_resize_instance,quota_instances' }}"
       class="quota_bar"
       data-progress-indicator-flavor
       data-quota-limit="{{ usages.maxTotalInstances }}"
       data-quota-used="{{ usages.totalInstancesUsed }}">
    {% widthratio usages.totalInstancesUsed usages.maxTotalInstances 100 as instance_percent %}
    {% bs_progress_bar instance_percent 0 %}
  </div>
  {% endminifyspace %}

  <div class="quota_title">
    <strong class="pull-left">{% trans "Number of VCPUs" %}</strong>
    <span class="pull-right">
      {% blocktrans trimmed with used=usages.totalCoresUsed|intcomma quota=usages.maxTotalCores|intcomma|quotainf %}
      {{ used }} of {{ quota }} Used
      {% endblocktrans %}
    </span>
  </div>

  {% minifyspace %}
  <div id="quota_vcpus"
       class="quota_bar"
       data-progress-indicator-flavor
       data-quota-limit="{{ usages.maxTotalCores }}"
       data-quota-used="{{ usages.totalCoresUsed }}">
    {% widthratio usages.totalCoresUsed usages.maxTotalCores 100 as vcpu_percent %}
    {% bs_progress_bar vcpu_percent 0 %}
  </div>
  {% endminifyspace %}

  <div class="quota_title">
    <strong class="pull-left">{% trans "Total RAM" %}</strong>
    <span class="pull-right">
      {% blocktrans trimmed with used=usages.totalRAMUsed|mb_to_gb quota=usages.maxTotalRAMSize|mb_to_gb %}
      {{ used }} of {{ quota }} GB Used
      {% endblocktrans %}
    </span>
  </div>

  {% minifyspace %}
  <div id="quota_ram"
       class="quota_bar"
       data-progress-indicator-flavor
       data-quota-limit="{{ usages.maxTotalRAMSize }}"
       data-quota-used="{{ usages.totalRAMUsed }}">
    {% widthratio usages.totalRAMUsed usages.maxTotalRAMSize 100 as ram_percent %}
    {% bs_progress_bar ram_percent 0 %}
  </div>
  {% endminifyspace %}

  {% if cinder_enabled %}
  <div class="quota_title">
    <strong class="pull-left">{% trans "Number of Volumes" %}</strong>
    <span class="pull-right">
      {% blocktrans with used=usages.totalVolumesUsed|intcomma quota=usages.maxTotalVolumes|intcomma|quotainf %}
      {{ used }} of {{ quota }} Used
      {% endblocktrans %}
    </span>
  </div>
  <div id="quota_volume"
       class="quota_bar"
       data-progress-indicator-flavor
       data-quota-limit="{{ usages.maxTotalVolumes }}"
       data-quota-used="{{ usages.totalVolumesUsed }}">
    {% widthratio usages.totalVolumesUsed usages.maxTotalVolumes 100 as volume_percent %}
    {% bs_progress_bar volume_percent 0 %}
  </div>

  <div class="quota_title">
    <strong class="pull-left">{% trans "Total Volume Storage" %}</strong>
    <span class="pull-right">
      {% blocktrans with used=usages.totalGigabytesUsed|intcomma quota=usages.maxTotalVolumeGigabytes|intcomma|quotainf %}
      {{ used }} of {{ quota }} GiB Used
      {% endblocktrans %}
    </span>
  </div>
  <div id="quota_volume_storage"
       class="quota_bar"
       data-progress-indicator-flavor
       data-quota-limit="{{ usages.maxTotalVolumeGigabytes }}"
       data-quota-used="{{ usages.totalGigabytesUsed }}">
     {% widthratio usages.totalGigabytesUsed usages.maxTotalVolumeGigabytes 100 as volume_storage_percent %}
     {% bs_progress_bar volume_storage_percent 0 %}
  </div>
  {% endif %}
</div>

<script type="text/javascript" charset="utf-8">
  some_disabled_msg = '{{ _("Some flavors not meeting minimum boot source requirements have been disabled.")|escapejs }}';
  all_disabled_msg  = '{{ _("No flavors meet minimum criteria for selected boot source.")|escapejs }}';

  function xloudPick(extra, keys, regexes) {
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      var v = (extra && Object.prototype.hasOwnProperty.call(extra, k)) ? extra[k] : undefined;
      if (v !== undefined && v !== null && String(v).trim() !== "") return String(v).trim();
    }
    if (regexes && extra) {
      for (var r = 0; r < regexes.length; r++) {
        var re = regexes[r];
        for (var kk in extra) {
          if (!Object.prototype.hasOwnProperty.call(extra, kk)) continue;
          var vv = extra[kk];
          if (re.test(kk) && vv !== undefined && vv !== null && String(vv).trim() !== "") return String(vv).trim();
        }
      }
    }
    return "";
  }

  function xloudUpdateMinReq(){
    try {
      if (!window.horizon || !horizon.Quota || !horizon.Quota.getSelectedFlavor) return;
      var fl = horizon.Quota.getSelectedFlavor() || {};
      var ex = fl["OS-FLV-WITH-EXT-SPECS:extra_specs"] || fl.extra_specs || {};

      var minCpu = xloudPick(ex,
        ["minimum_cpu","aggregate_instance_extra_specs:minimum_cpu","hw:cpu_min","cpu_min","min_cpu"],
        [/cpu.*min/i, /min.*cpu/i]
      );

      var minMem = xloudPick(ex,
        ["minimum_memory","minimum_mem","aggregate_instance_extra_specs:minimum_memory","hw:mem_min","mem_min","minimum_memory_mb"],
        [/mem.*min/i, /min.*mem/i]
      );

      var cpuEl = document.getElementById("flavor_minimum_cpu");
      var memEl = document.getElementById("flavor_minimum_memory");
      var ramEl = document.getElementById("flavor_ram");

      // helper: convert a MB numeric/string -> numeric GB string (no unit)
      function mbToGbNumericString(val) {
        if (val === undefined || val === null) return "";
        var s = String(val).trim();
        if (s === "") return "";
        var n = parseFloat(s.replace(/[^\d.\-]/g, ''));
        if (isNaN(n)) return s;
        var gb = n / 1024.0;
        if (Math.abs(gb - Math.round(gb)) < 1e-9) return String(Math.round(gb));
        return gb.toFixed(1);
      }

      // Set RAM: prefer server-provided numeric ram_gb, fallback to ram_mb or fl.ram (MB)
      try {
        var ramVal = undefined;
        if (fl && fl.ram_gb !== undefined) {
          ramVal = fl.ram_gb;
          var g = parseFloat(ramVal);
          ramEl && (ramEl.textContent = isNaN(g) ? String(ramVal) : ((Math.abs(g - Math.round(g)) < 1e-9) ? String(Math.round(g)) : g.toFixed(1)));
        } else if (fl && fl.ram_mb !== undefined) {
          ramEl && (ramEl.textContent = mbToGbNumericString(fl.ram_mb));
        } else if (fl && fl.ram !== undefined) {
          ramEl && (ramEl.textContent = mbToGbNumericString(fl.ram));
        } else {
          ramEl && (ramEl.textContent = "");
        }
      } catch (e) { /* ignore */ }

      if (cpuEl) cpuEl.textContent = minCpu;
      if (memEl) memEl.textContent = mbToGbNumericString(minMem);

      // Hide/show the two rows
      var cpuRow = cpuEl ? cpuEl.closest("tr") : null;
      var memRow = memEl ? memEl.closest("tr") : null;
      if (cpuRow) cpuRow.style.display = minCpu ? "" : "none";
      if (memRow) memRow.style.display = minMem ? "" : "none";

      // NEW: toggle headline row if either value is present
      var head = document.getElementById("hot_add_headline_row");
      if (head) head.style.display = (minCpu || minMem) ? "" : "none";
    } catch (e) { /* keep modal functional */ }
  }

  function xloudInit() {
    horizon.Quota.initWithFlavors({{ flavors|safe|default:"{}" }});
    horizon.Quota.initWithImages({{ images|safe|default:"{}" }}, some_disabled_msg, all_disabled_msg);

    if (horizon.Quota && typeof horizon.Quota.showFlavorDetails === 'function' && !horizon.Quota._xloud_patched) {
      var _orig = horizon.Quota.showFlavorDetails;
      horizon.Quota.showFlavorDetails = function() {
        var r = _orig.apply(this, arguments);
        try { xloudUpdateMinReq(); } catch(e) {}
        return r;
      };
      horizon.Quota._xloud_patched = true;
    }

    var sel = document.getElementById('id_flavor');
    if (sel && !sel._xloud_bound) {
      sel.addEventListener('change', xloudUpdateMinReq);
      sel.addEventListener('keyup', xloudUpdateMinReq);
      sel._xloud_bound = true;
    }

    setTimeout(xloudUpdateMinReq, 0);
  }

  (function waitReady(tries){
    if (typeof horizon !== 'undefined' && horizon.Quota) {
      xloudInit();
    } else if (tries > 0) {
      setTimeout(function(){ waitReady(tries - 1); }, 150);
    }
  })(40);
</script>
